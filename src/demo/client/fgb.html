<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Home</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/underscore@1.13.1/underscore-min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/flatgeobuf@3.32.0/dist/flatgeobuf-geojson.min.js"></script>
  <script src="https://unpkg.com/json-formatter-js@2.5.23/dist/json-formatter.umd.js"></script>
</head>
<body>
  <header id="navbar"></header>

  <main>
    <h1>FlatGeoBuf</h1>
    <h2>N50_samferdsel_senterlinje.fgb</h2>
    <div class="fileBarContainer">
      <div class="fileBarItem">0 B</div>
      <div id="fileBar"></div>
      <div id="fileSize" class="fileBarItem"></div>
    </div>
    <h2></h2>
    <div id="map"></div>
    <h3>Metadata</h3>
    <div id="header"></div>
  </main>

  <footer id="footer"></footer>
  <script>
    const bar = document.getElementById('fileBar');
    const fs = document.getElementById('fileSize');
    const barWidth = bar.clientWidth;

    let cl = null;
    const fileHead = fetch(
      "http://localhost:8081/fgb/n50_samferdsel_senterlinje.fgb",
      // "http://localhost:8081/fgb/hurtigurten.fgb",
      {method: 'HEAD'}
    ).then(fh => {
      cl = fh.headers.get('content-length');
      fs.textContent = `${Number(cl / 1024 / 1024, 2).toFixed(2)} MB`
    })

    // Register the Service Worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').then(() => {
        console.log('[main] Service Worker registered.');
      });

      // Listen for messages from the SW
      navigator.serviceWorker.addEventListener('message', event => {
        const data = event.data;
        if (data?.type === 'range-log') {
          if (data.start && data.end) {
              const left = Math.ceil((data.start / cl) * barWidth);
              const width = Math.ceil(((data.end - data.start) / cl) * barWidth);

              const rangeDiv = document.createElement('div');
              rangeDiv.className = 'range';
              rangeDiv.style.left = `${left}px`;
              rangeDiv.style.width = `${width}px`;

              // Calculate size in KB
              const sizeKB = ((data.end - data.start) / 1024).toFixed(2);

              // Create tooltip element
              const tooltip = document.createElement('div');
              tooltip.className = 'tooltip';
              tooltip.innerText = `Bytes: ${data.start}-${data.end} | Size: ${sizeKB} KB`;
              tooltip.style.position = 'absolute';
              tooltip.style.padding = '5px 8px';
              tooltip.style.background = 'rgba(0,0,0,0.7)';
              tooltip.style.color = '#fff';
              tooltip.style.borderRadius = '4px';
              tooltip.style.fontSize = '18px';
              tooltip.style.pointerEvents = 'none';
              tooltip.style.opacity = '0';
              tooltip.style.transition = 'opacity 0.2s';
              tooltip.style.zIndex = 10000;

              // Show tooltip on hover
              rangeDiv.addEventListener('mouseenter', (e) => {
                  tooltip.style.opacity = '1';
                  document.body.appendChild(tooltip);
              });

              rangeDiv.addEventListener('mousemove', (e) => {
                  tooltip.style.left = e.pageX + 10 + 'px';
                  tooltip.style.top = e.pageY + 10 + 'px';
              });

              rangeDiv.addEventListener('mouseleave', () => {
                  tooltip.style.opacity = '0';
                  tooltip.remove();
              });

              bar.appendChild(rangeDiv);
          }
        }
      });
    }

  </script>
  <script src="app.js"></script>
  <script src="fgb.js"></script>
</body>
</html>
